<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truth Table Interface Test</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@2.4.4/dist/index.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .truth-table-wrapper {
            margin: 1rem 0;
            background: white;
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            min-height: 50px;
        }
        .math-renderer {
            width: 100%;
        }
        .formula-display {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Truth Table Interface Test</h1>

        <el-button @click="testSimpleTable">Test Simple Table</el-button>
        <el-button @click="testComplexTable">Test Complex Table</el-button>
        <el-button @click="clearResults">Clear</el-button>

        <div v-if="results.length > 0" class="results-section">
            <h3>Results:</h3>
            <div v-for="result in results" :key="result.index" class="result-item">
                <div class="formula-display">
                    <strong>Formula {{ result.index }}:</strong> {{ result.formula }}
                </div>
                <div class="truth-table-wrapper">
                    <!-- Simulate the MathRenderer component -->
                    <div class="math-renderer" ref="mathContainer">
                        {{ result.tableData.latexTable }}
                    </div>
                </div>
            </div>
        </div>

        <div class="console-log" style="margin-top: 20px; padding: 10px; background: #f0f0f0; height: 200px; overflow-y: auto; font-family: monospace;">
            <div v-for="(log, index) in consoleLogs" :key="index" :style="{color: log.type === 'error' ? 'red' : log.type === 'warn' ? 'orange' : 'black'}">
                [{{ log.time }}] {{ log.message }}
            </div>
        </div>
    </div>

    <script>
        // Configure MathJax
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };

        // Load MathJax
        const mathJaxScript = document.createElement('script');
        mathJaxScript.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
        mathJaxScript.async = true;
        document.head.appendChild(mathJaxScript);

        const { createApp, ref } = Vue;

        createApp({
            setup() {
                const results = ref([]);
                const consoleLogs = ref([]);

                const addLog = (message, type = 'log') => {
                    consoleLogs.value.push({
                        time: new Date().toLocaleTimeString(),
                        message: message,
                        type: type
                    });
                    console.log(message);
                };

                const testSimpleTable = async () => {
                    addLog('Testing simple table...');
                    try {
                        const response = await fetch('/api/truth-table/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                formulas: ['p \\wedge q'],
                                detailed: false,
                                checkType: true
                            })
                        });

                        const data = await response.json();
                        addLog('API response received');

                        if (data.latexTable) {
                            const result = {
                                index: results.value.length + 1,
                                formula: 'p ∧ q',
                                tableData: data
                            };
                            results.value.push(result);

                            // Wait for DOM update
                            setTimeout(() => {
                                const containers = document.querySelectorAll('.math-renderer');
                                addLog(`Found ${containers.length} math containers`);

                                containers.forEach((container, index) => {
                                    if (container.innerHTML.includes('\\begin{array}')) {
                                        container.innerHTML = data.latexTable;
                                        addLog(`Set content for container ${index}`);

                                        if (window.MathJax && window.MathJax.typeset) {
                                            window.MathJax.typeset([container]);
                                            addLog(`MathJax rendered container ${index}`);
                                        }
                                    }
                                });
                            }, 100);
                        }
                    } catch (error) {
                        addLog('Error: ' + error.message, 'error');
                    }
                };

                const testComplexTable = async () => {
                    addLog('Testing complex table...');
                    try {
                        const response = await fetch('/api/truth-table/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                formulas: ['(p \\wedge q) \\vee \\neg r'],
                                detailed: true,
                                checkType: true
                            })
                        });

                        const data = await response.json();
                        addLog('API response received');

                        if (data.latexTable) {
                            const result = {
                                index: results.value.length + 1,
                                formula: '(p ∧ q) ∨ ¬ r',
                                tableData: data
                            };
                            results.value.push(result);

                            // Wait for DOM update
                            setTimeout(() => {
                                const containers = document.querySelectorAll('.math-renderer');
                                addLog(`Found ${containers.length} math containers`);

                                containers.forEach((container, index) => {
                                    if (container.innerHTML.includes('\\begin{array}')) {
                                        container.innerHTML = data.latexTable;
                                        addLog(`Set content for container ${index}`);

                                        if (window.MathJax && window.MathJax.typeset) {
                                            window.MathJax.typeset([container]);
                                            addLog(`MathJax rendered container ${index}`);
                                        }
                                    }
                                });
                            }, 100);
                        }
                    } catch (error) {
                        addLog('Error: ' + error.message, 'error');
                    }
                };

                const clearResults = () => {
                    results.value = [];
                    addLog('Results cleared');
                };

                return {
                    results,
                    consoleLogs,
                    testSimpleTable,
                    testComplexTable,
                    clearResults
                };
            }
        }).mount('#app');
    </script>
</body>
</html>